#' A 'ggplot2' geom to draw aptamers
#'
#' `geom_aptamer()` draws a geom representing an aptamer, a short
#' polynucleotide or polypeptide sequence that binds a target molecule.
#'
#' The geom is drawn as a stylised secondary structure of a short
#' polynucleotide. The position of the aptamer on the molecular backbone is
#' expressed with the `x` aesthetic. Aptamers are not oriented, so this geom
#' does not accept the `forward` aesthetic. The aptamer is drawn with an
#' internal fill, which is white by default.
#'
#' @section Aesthetics:
#'
#' - x (required; position of the aptamer)
#' - y (required; the molecular backbone)
#' - alpha
#' - colour
#' - linetype
#' - size
#' - fill
#'
#' @param mapping,data,stat,position,na.rm,show.legend,inherit.aes,... As
#' standard for ggplot2. inherit.aes is set to FALSE by default.
#' @param height `grid::unit()` opbject giving the height of the aptamer above
#' the molecular backbone. Defaults to 3 mm. The aspect ratio of the aptamer is
#' fixed, so the width of the geom will be equal to the height.
#'
#' @examples
#'
#' ggplot2::ggplot(example_SBOL_features[example_SBOL_features$type == "aptamer", ],
#'                 ggplot2::aes(x = start, y = molecule)) +
#'   geom_aptamer(inherit.aes = TRUE)
#'
#' @seealso [geom_aptamer()]
#'
#' @export
geom_aptamer <- function(
  mapping = NULL,
  data = NULL,
  stat = "identity",
  position = "identity",
  na.rm = FALSE,
  show.legend = NA,
  inherit.aes = FALSE,
  height = grid::unit(3, "mm"),
  ...
) {
  ggplot2::layer(
    geom = GeomAptamer,
    mapping = mapping,
    data = data,
    stat = stat,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(
      na.rm = na.rm,
      height = height,
      ...
    ) 
  )
}

#' GeomAptamer
#' @noRd
GeomAptamer <- ggplot2::ggproto("GeomAptamer", ggplot2::Geom,
  required_aes = c("x", "y"),
  default_aes = ggplot2::aes(
    alpha = 1,
    colour = "black",
    linetype = 1,
    size = 1,
    fill = "white"
  ),

  draw_key = ggplot2::draw_key_abline,

  setup_data = function(data, params) {
    data
  },

  draw_panel = function(data, panel_scales, coord, height) {

    # Detect coordinate system and transform values
    coord_system <- get_coord_system(coord)
    data <- data_to_grid(data, coord_system, panel_scales, coord)

    gt <- grid::gTree(
      data = data,
      cl = "aptamertree",
      height = height,
      coord_system = coord_system
    )
    gt$name <- grid::grobName(gt, "geom_aptamer")
    gt
  }
)

#' @importFrom grid makeContent
#' @export
makeContent.aptamertree <- function(x) {

  data <- x$data

  # Prepare grob for each aptamer
  grobs <- lapply(seq_len(nrow(data)), function(i) {

    aptamer <- data[i, ]

    # Set up geometry
    r <- ifelse(x$coord_system == "polar", aptamer$away, NA)
    awayness <- unit_to_alaw(x$height, "away", x$coord_system, r) 
    alongness <- unit_to_alaw(x$height, "along", x$coord_system, r)

    # Generate the polygon. The grob is drawn such that the 'stalk' of the
    # aptamer is centred on the along coordinate.
    alongs <- aptamer$along - (alongness * 0.3580604) + (alongness * c(
      0.4,
      0.4,
      0.4,
      0.407409990587742,
      0.41467721998533,
      0.421793160851203,
      0.4287492858438,
      0.43553706762156,
      0.442147978842921,
      0.448573492166323,
      0.454805080250204,
      0.460834215753003,
      0.46665237133316,
      0.472251019649113,
      0.477621633359301,
      0.482755685122163,
      0.487644647596139,
      0.492279993439665,
      0.496653195311183,
      0.50075572586913,
      0.504579057771946,
      0.50811466367807,
      0.51135401624594,
      0.514288588133995,
      0.516909852000674,
      0.519209280504417,
      0.521178346303662,
      0.522808522056847,
      0.524091280422413,
      0.525018094058797,
      0.525580435624439,
      0.525769777777778,
      0.525769777777778,
      0.525760583605542,
      0.52573307259648,
      0.525687352012064,
      0.525623529113763,
      0.525541711163047,
      0.525442005421388,
      0.525324519150254,
      0.525189359611118,
      0.525036634065449,
      0.524866449774716,
      0.524678914000392,
      0.524474134003945,
      0.524252217046847,
      0.524013270390568,
      0.523757401296577,
      0.523484717026346,
      0.523195324841345,
      0.522889332003043,
      0.522566845772912,
      0.522227973412422,
      0.521872822183042,
      0.521501499346244,
      0.521114112163498,
      0.520710767896274,
      0.520291573806042,
      0.519856637154273,
      0.519406065202436,
      0.518939965212004,
      0.518458444444444,
      0.670556,
      0.670556,
      0.671782571769605,
      0.67301968949572,
      0.674267249907745,
      0.675525149735081,
      0.676793285707127,
      0.678071554553282,
      0.679359853002948,
      0.680658077785523,
      0.681966125630407,
      0.683283893267001,
      0.684611277424704,
      0.685948174832917,
      0.687294482221038,
      0.688650096318468,
      0.690014913854607,
      0.691388831558854,
      0.69277174616061,
      0.694163554389274,
      0.695564152974246,
      0.696973438644926,
      0.698391308130715,
      0.699817658161011,
      0.701252385465214,
      0.702695386772725,
      0.704146558812944,
      0.70560579831527,
      0.707073002009103,
      0.708548066623842,
      0.710030888888889,
      0.710030888888889,
      0.714789767454362,
      0.719478884515333,
      0.724091169015175,
      0.728619549897267,
      0.733056956104984,
      0.737396316581701,
      0.741630560270796,
      0.745752616115644,
      0.749755413059622,
      0.753631880046105,
      0.757374946018469,
      0.760977539920092,
      0.764432590694348,
      0.767733027284614,
      0.770871778634266,
      0.77384177368668,
      0.776635941385233,
      0.7792472106733,
      0.781668510494257,
      0.783892769791481,
      0.785912917508349,
      0.787721882588234,
      0.789312593974515,
      0.790677980610567,
      0.791810971439766,
      0.792704495405488,
      0.79335148145111,
      0.793744858520007,
      0.793877555555556,
      0.793877555555556,
      0.793744858520007,
      0.79335148145111,
      0.792704495405488,
      0.791810971439766,
      0.790677980610567,
      0.789312593974515,
      0.787721882588234,
      0.785912917508349,
      0.783892769791482,
      0.781668510494257,
      0.7792472106733,
      0.776635941385233,
      0.77384177368668,
      0.770871778634266,
      0.767733027284614,
      0.764432590694348,
      0.760977539920091,
      0.757374946018469,
      0.753631880046105,
      0.749755413059622,
      0.745752616115644,
      0.741630560270796,
      0.737396316581701,
      0.733056956104984,
      0.728619549897267,
      0.724091169015175,
      0.719478884515333,
      0.714789767454362,
      0.710030888888889,
      0.710030888888889,
      0.705270403815928,
      0.700579907235047,
      0.695966457792903,
      0.691437114136154,
      0.686998934911458,
      0.682658978765473,
      0.678424304344855,
      0.674301970296263,
      0.670299035266354,
      0.666422557901786,
      0.662679596849217,
      0.659077210755304,
      0.655622458266705,
      0.652322398030077,
      0.649184088692079,
      0.646214588899367,
      0.6434209572986,
      0.640810252536435,
      0.63838953325953,
      0.636165858114542,
      0.634146285748129,
      0.632337874806949,
      0.630747683937659,
      0.629382771786917,
      0.62825019700138,
      0.627357018227708,
      0.626710294112555,
      0.626317083302582,
      0.626184444444445,
      0.626184444444445,
      0.626185142937846,
      0.626187178646111,
      0.626190461911335,
      0.626194903075612,
      0.626200412481037,
      0.626206900469702,
      0.626214277383702,
      0.626222453565132,
      0.626231339356085,
      0.626240845098656,
      0.626250881134938,
      0.626261357807026,
      0.626272185457014,
      0.626283274426996,
      0.626294535059066,
      0.626305877695318,
      0.626317212677847,
      0.626328450348746,
      0.626339501050109,
      0.626350275124031,
      0.626360682912606,
      0.626370634757928,
      0.626380041002091,
      0.626388811987189,
      0.626396858055316,
      0.626404089548567,
      0.626410416809035,
      0.626415750178815,
      0.62642,
      0.474506888888889,
      0.474506888888889,
      0.471347686570904,
      0.468112807404067,
      0.464803860310432,
      0.461422454212054,
      0.457970198030989,
      0.454448700689291,
      0.450859571109015,
      0.447204418212218,
      0.443484850920953,
      0.439702478157275,
      0.43585890884324,
      0.431955751900903,
      0.427994616252318,
      0.423977110819541,
      0.419904844524626,
      0.41577942628963,
      0.411602465036606,
      0.40737556968761,
      0.403100349164696,
      0.398778412389921,
      0.394411368285338,
      0.390000825773003,
      0.385548393774972,
      0.381055681213298,
      0.376524297010037,
      0.371955850087243,
      0.367351949366973,
      0.362714203771281,
      0.358044222222222,
      0.358044222222222,
      0.348531330572526,
      0.339157280859768,
      0.329936252317757,
      0.3208824241803,
      0.312009975681204,
      0.303333086054278,
      0.294865934533328,
      0.286622700352163,
      0.278617562744589,
      0.270864700944415,
      0.263378294185448,
      0.256172521701496,
      0.249261562726366,
      0.242659596493866,
      0.236380802237803,
      0.230439359191986,
      0.224849446590221,
      0.219625243666316,
      0.214780929654079,
      0.210330683787318,
      0.206288685299839,
      0.202669113425452,
      0.199486147397962,
      0.196753966451178,
      0.194486749818908,
      0.192698676734958,
      0.191403926433137,
      0.190616678147252,
      0.190351111111111,
      0.190351111111111,
      0.19054045326445,
      0.191102794830092,
      0.192029608466476,
      0.193312366832042,
      0.194942542585228,
      0.196911608384472,
      0.199211036888215,
      0.201832300754894,
      0.204766872642949,
      0.208006225210819,
      0.211541831116943,
      0.215365163019759,
      0.219467693577706,
      0.223840895449224,
      0.228476241292751,
      0.233365203766726,
      0.238499255529588,
      0.243869869239776,
      0.249468517555729,
      0.255286673135886,
      0.261315808638685,
      0.267547396722566,
      0.273972910045968,
      0.280583821267329,
      0.287371603045089,
      0.294327728037686,
      0.301443668903559,
      0.308710898301147,
      0.316120888888889,
      0.316120888888889
    ))
    aways <- aptamer$away + (awayness * (0.866666666666667 - c(
      0.866666666666667,
      0.609626666666667,
      0.609626666666667,
      0.607535371638398,
      0.605118226377101,
      0.602383650962866,
      0.599340065475784,
      0.595995889995945,
      0.592359544603442,
      0.588439449378362,
      0.5842440244008,
      0.579781689750844,
      0.575060865508585,
      0.570089971754115,
      0.564877428567524,
      0.559431656028902,
      0.553761074218341,
      0.547874103215931,
      0.541779163101763,
      0.535484673955927,
      0.528999055858515,
      0.522330728889618,
      0.515488113129325,
      0.508479628657728,
      0.501313695554918,
      0.493998733900984,
      0.486543163776019,
      0.478955405260113,
      0.471243878433356,
      0.463417003375839,
      0.455483200167653,
      0.447450888888889,
      0.447450888888889,
      0.445687115976693,
      0.443927849467656,
      0.442173167703108,
      0.440423149024378,
      0.438677871772794,
      0.436937414289684,
      0.435201854916378,
      0.433471271994205,
      0.431745743864493,
      0.43002534886857,
      0.428310165347766,
      0.426600271643409,
      0.424895746096829,
      0.423196667049353,
      0.42150311284231,
      0.41981516181703,
      0.418132892314841,
      0.416456382677072,
      0.414785711245051,
      0.413120956360108,
      0.41146219636357,
      0.409809509596767,
      0.408162974401028,
      0.406522669117681,
      0.404888672088054,
      0.403261061653478,
      0.401639916155279,
      0.400025313934788,
      0.398417333333333,
      0.310596444444444,
      0.310596444444444,
      0.311246868287616,
      0.311879461032068,
      0.312493859672621,
      0.313089701204095,
      0.313666622621309,
      0.314224260919085,
      0.314762253092241,
      0.315280236135598,
      0.315777847043977,
      0.316254722812197,
      0.316710500435078,
      0.31714481690744,
      0.317557309224104,
      0.317947614379889,
      0.318315369369616,
      0.318660211188104,
      0.318981776830174,
      0.319279703290646,
      0.319553627564339,
      0.319803186646074,
      0.320028017530672,
      0.320227757212951,
      0.320402042687733,
      0.320550510949836,
      0.320672798994082,
      0.32076854381529,
      0.32083738240828,
      0.320878951767873,
      0.320892888888889,
      0.320892888888889,
      0.32076019185334,
      0.320366814784443,
      0.319719828738821,
      0.318826304773099,
      0.3176933139439,
      0.316327927307848,
      0.314737215921567,
      0.312928250841682,
      0.310908103124815,
      0.308683843827591,
      0.306262544006633,
      0.303651274718566,
      0.300857107020014,
      0.297887111967599,
      0.294748360617947,
      0.291447924027681,
      0.287992873253425,
      0.284390279351802,
      0.280647213379438,
      0.276770746392955,
      0.272767949448977,
      0.268645893604129,
      0.264411649915034,
      0.260072289438317,
      0.2556348832306,
      0.251106502348509,
      0.246494217848666,
      0.241805100787696,
      0.237046222222222,
      0.237046222222222,
      0.23228897314363,
      0.227601258527296,
      0.22299016178514,
      0.218462766329083,
      0.214026155571045,
      0.209687412922948,
      0.205453621796711,
      0.201331865604257,
      0.197329227757505,
      0.193452791668375,
      0.189709640748789,
      0.186106858410668,
      0.182651528065931,
      0.179350733126501,
      0.176211557004296,
      0.173241083111239,
      0.170446394859249,
      0.167834575660248,
      0.165412708926155,
      0.163187878068893,
      0.16116716650038,
      0.159357657632539,
      0.15776643487729,
      0.156400581646553,
      0.155267181352249,
      0.154373317406299,
      0.153726073220623,
      0.153332532207142,
      0.153199777777778,
      0.153199777777778,
      0.153332532207143,
      0.153726073220623,
      0.154373317406299,
      0.155267181352249,
      0.156400581646553,
      0.15776643487729,
      0.159357657632539,
      0.16116716650038,
      0.163187878068893,
      0.165412708926155,
      0.167834575660247,
      0.170446394859249,
      0.173241083111239,
      0.176211557004296,
      0.179350733126501,
      0.182651528065931,
      0.186106858410668,
      0.189709640748789,
      0.193452791668375,
      0.197329227757504,
      0.201331865604257,
      0.205453621796712,
      0.209687412922948,
      0.214026155571045,
      0.218462766329083,
      0.22299016178514,
      0.227601258527296,
      0.23228897314363,
      0.237046222222222,
      0.237046222222222,
      0.237124258495405,
      0.237202054222987,
      0.237279622525638,
      0.237356976524025,
      0.237434129338818,
      0.237511094090687,
      0.237587883900301,
      0.237664511888328,
      0.237740991175439,
      0.237817334882301,
      0.237893556129585,
      0.237969668037959,
      0.238045683728092,
      0.238121616320655,
      0.238197478936315,
      0.238273284695742,
      0.238349046719605,
      0.238424778128573,
      0.238500492043316,
      0.238576201584503,
      0.238651919872802,
      0.238727660028884,
      0.238803435173416,
      0.238879258427069,
      0.238955142910511,
      0.239031101744411,
      0.239107148049439,
      0.239183294946264,
      0.239259555555556,
      0.326946444444444,
      0.326946444444444,
      0.323968082086186,
      0.321071082637437,
      0.31825712926137,
      0.315527905121161,
      0.312885093379984,
      0.310330377201015,
      0.307865439747427,
      0.305491964182395,
      0.303211633669095,
      0.3010261313707,
      0.298937140450385,
      0.296946344071325,
      0.295055425396695,
      0.293266067589669,
      0.291579953813422,
      0.289998767231129,
      0.288524191005963,
      0.287157908301101,
      0.285901602279716,
      0.284756956104983,
      0.283725652940078,
      0.282809375948173,
      0.282009808292445,
      0.281328633136068,
      0.280767533642216,
      0.280328192974064,
      0.280012294294787,
      0.279821520767559,
      0.279757555555555,
      0.279757555555555,
      0.280023007020469,
      0.280809925102847,
      0.282104155334144,
      0.283891543245817,
      0.28615793436932,
      0.288889174236108,
      0.292071108377638,
      0.295689582325365,
      0.299730441610744,
      0.304179531765231,
      0.309022698320281,
      0.314245786807349,
      0.319834642757892,
      0.325775111703363,
      0.33205303917522,
      0.338654270704917,
      0.34556465182391,
      0.352770028063653,
      0.360256244955604,
      0.368009148031216,
      0.376014582821946,
      0.384258394859249,
      0.39272642967458,
      0.401404532799395,
      0.410278549765149,
      0.419334326103298,
      0.428557707345297,
      0.437934539022601,
      0.447450666666667,
      0.447450666666667,
      0.455484585227402,
      0.463419770206058,
      0.471247813823172,
      0.478960308299279,
      0.486548845854916,
      0.494005018710621,
      0.501320419086929,
      0.508486639204377,
      0.515495271283502,
      0.52233790754484,
      0.529006140208928,
      0.535491561496303,
      0.5417857636275,
      0.547880338823058,
      0.553766879303511,
      0.559436977289397,
      0.564882225001253,
      0.570094214659614,
      0.575064538485018,
      0.579784788698001,
      0.5842465575191,
      0.588441437168851,
      0.592361019867791,
      0.595996897836456,
      0.599340663295383,
      0.60238390846511,
      0.605118225566171,
      0.607535206819103,
      0.609626444444444,
      0.866666444444444
    )))

    # If in polar coordinates, segment the polygon
    if (x$coord_system == "polar") {
      segmented <- segment_polargon(alongs, aways)
      alongs <- segmented$thetas
      aways <- segmented$rs
    }

    # Convert polygon into Cartesian coordinates within the grid viewport
    coords <- alaw_to_grid(alongs, aways, x$coord_system, r)

    # Generate polygon group for the aptamer
    pg <- grid::polygonGrob(
      x = coords$x,
      y = coords$y,
      gp = grid::gpar(
        col = aptamer$colour,
        fill = aptamer$fill,
        lty = aptamer$linetype,
        lwd = aptamer$size
      )
    )

    # Return the grob
    pg
  })

  class(grobs) <- "gList"
  grid::setChildren(x, grobs)
}
